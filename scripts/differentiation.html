<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>微分ビジュアライザ</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    body { padding: 16px; }
    .layout { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; align-items: start; }
    canvas { width: 100%; height: 360px; border-radius: 12px; border: 1px solid #e5e7eb; background: #f9fafb; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 8px 18px rgba(0,0,0,0.05); }
    .card h3 { margin-top: 0; }
    label { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 10px; font-size: 14px; color: #374151; }
    input[type="range"] { width: 100%; }
    select { padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; width: 100%; }
    .formula { background: #f3f4f6; padding: 8px; border-radius: 8px; font-family: 'SFMono-Regular', Consolas, monospace; font-size: 14px; }
    body.contrast { background: #0b1021; color: #e5e7eb; }
    body.contrast canvas { background: #111827; border-color: #374151; }
    body.contrast .card { background: #0f172a; border-color: #374151; box-shadow: none; }
    body.contrast .formula { background: #111827; color: #e5e7eb; }
    body.contrast select, body.contrast input[type="range"] { color: #e5e7eb; }
  </style>
</head>
<body>
  <h2>微分：接線の傾きで「変化の速さ」を理解する</h2>
  <p>点をスライダーで動かしながら、接線の傾き（導関数）がどのように変化するかを観察します。関数を切り替えて形の違いを比べてみましょう。導関数の全体曲線もオプションで表示できます。</p>
  <div class="layout">
    <canvas id="diffCanvas" width="720" height="360" aria-label="微分キャンバス"></canvas>
    <div class="card">
      <h3>操作パネル</h3>
      <label>関数を選択<select id="funcSelect"><option value="quadratic">f(x)=x^2</option><option value="sine">f(x)=sin(x)</option><option value="cubic">f(x)=0.1x^3-0.5x</option></select></label>
      <label>点の位置 x
        <input id="xPos" type="range" min="-3" max="3" step="0.05" value="-1.5" />
      </label>
      <label>近似用の幅 h（小さいほど接線に近い）
        <input id="hVal" type="range" min="0.05" max="1.0" step="0.05" value="0.4" />
      </label>
      <label>導関数曲線を表示
        <input id="showDerivative" type="checkbox" checked />
      </label>
      <div class="formula" id="infoBox"></div>
      <div class="hint" style="margin-top:10px;">
        <strong>学習ヒント</strong>
        <ul style="padding-left:18px; margin:6px 0;">
          <li>緑の線：関数そのもの。赤い点の位置を動かすと形に沿って移動します。</li>
          <li>オレンジの線：h を使った割線（2 点を結ぶ線）。h を小さくするほど接線に近づきます。</li>
          <li>紫の線：実際の接線。傾きは導関数 f'(x) です。テキスト欄に値を表示します。</li>
          <li>導関数の曲線を重ねて、各 x で傾きがどう変化するかを全体像で確認できます。</li>
        </ul>
      </div>
    </div>
  </div>

<script>
const canvas = document.getElementById('diffCanvas');
const ctx = canvas.getContext('2d');
const funcSelect = document.getElementById('funcSelect');
const xSlider = document.getElementById('xPos');
const hSlider = document.getElementById('hVal');
const infoBox = document.getElementById('infoBox');
const derivativeToggle = document.getElementById('showDerivative');

const functions = {
  quadratic: {
    f: (x) => x*x,
    df: (x) => 2*x,
    label: 'f(x) = x^2'
  },
  sine: {
    f: (x) => Math.sin(x),
    df: (x) => Math.cos(x),
    label: 'f(x) = sin(x)'
  },
  cubic: {
    f: (x) => 0.1*x*x*x - 0.5*x,
    df: (x) => 0.3*x*x - 0.5,
    label: 'f(x) = 0.1x^3 - 0.5x'
  }
};

function transform(x, y) {
  return {
    x: canvas.width/2 + x*80,
    y: canvas.height/2 - y*80
  };
}

function drawAxis() {
  ctx.strokeStyle = '#d1d5db';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(0, canvas.height/2);
  ctx.lineTo(canvas.width, canvas.height/2);
  ctx.moveTo(canvas.width/2, 0);
  ctx.lineTo(canvas.width/2, canvas.height);
  ctx.stroke();
}

function draw() {
  const key = funcSelect.value;
  const {f, df, label} = functions[key];
  const x0 = parseFloat(xSlider.value);
  const h = parseFloat(hSlider.value);

  ctx.clearRect(0,0,canvas.width, canvas.height);
  drawAxis();

  // 関数グラフ
  ctx.strokeStyle = '#10b981';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let px=0; px<canvas.width; px++) {
    const x = (px - canvas.width/2)/80;
    const y = f(x);
    const p = transform(x,y);
    px === 0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y);
  }
  ctx.stroke();

  if (derivativeToggle.checked) {
    ctx.strokeStyle = '#6366f1';
    ctx.beginPath();
    for (let px=0; px<canvas.width; px++) {
      const x = (px - canvas.width/2)/80;
      const y = df(x);
      const p = transform(x,y);
      px === 0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y);
    }
    ctx.stroke();
  }

  // 点と接線
  const y0 = f(x0);
  const slope = df(x0);
  const tangent = (x) => y0 + slope*(x-x0);

  // 割線
  const x1 = x0 + h;
  const y1 = f(x1);
  const secantSlope = (y1 - y0)/h;
  const secant = (x) => y0 + secantSlope*(x-x0);

  ctx.strokeStyle = '#f97316';
  ctx.lineWidth = 2;
  ctx.beginPath();
  const p0 = transform(x0, secant(x0));
  const p1 = transform(x0+1, secant(x0+1));
  ctx.moveTo(p0.x, p0.y);
  ctx.lineTo(p1.x, p1.y);
  ctx.stroke();

  ctx.strokeStyle = '#8b5cf6';
  ctx.beginPath();
  const t0 = transform(x0, tangent(x0));
  const t1 = transform(x0+1, tangent(x0+1));
  ctx.moveTo(t0.x, t0.y);
  ctx.lineTo(t1.x, t1.y);
  ctx.stroke();

  // 点
  ctx.fillStyle = '#ef4444';
  const point = transform(x0, y0);
  ctx.beginPath();
  ctx.arc(point.x, point.y, 6, 0, Math.PI*2);
  ctx.fill();

  // 導関数曲線上の対応点
  if (derivativeToggle.checked) {
    const dPoint = transform(x0, slope);
    ctx.fillStyle = '#6366f1';
    ctx.beginPath();
    ctx.arc(dPoint.x, dPoint.y, 4, 0, Math.PI*2);
    ctx.fill();
  }

  infoBox.innerHTML = `
    <div><strong>${label}</strong></div>
    <div>x = ${x0.toFixed(2)}</div>
    <div>接線の傾き f'(x) = ${slope.toFixed(3)}</div>
    <div>割線の傾き ≈ ${(secantSlope).toFixed(3)} （h=${h.toFixed(2)}）</div>
    <div>差分 |f'(x) - 割線| ≈ ${Math.abs(slope-secantSlope).toFixed(3)}</div>
  `;

  requestAnimationFrame(draw);
}

draw();

window.addEventListener('message', (event)=>{
  if (event.data?.type === 'contrast') {
    document.body.classList.toggle('contrast', event.data.enabled);
  }
});
</script>
</body>
</html>
