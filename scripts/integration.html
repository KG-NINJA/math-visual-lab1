<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>積分ビジュアライザ</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    body { padding: 16px; }
    .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; align-items: start; }
    canvas { width: 100%; height: 360px; border-radius: 12px; border: 1px solid #e5e7eb; background: #f9fafb; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 12px; box-shadow: 0 8px 18px rgba(0,0,0,0.05); }
    .panel h3 { margin-top: 0; }
    label { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 10px; font-size: 14px; color: #374151; }
    input[type="range"] { width: 100%; }
    select { padding: 8px; border-radius: 8px; border: 1px solid #d1d5db; width: 100%; }
    .stats { background: #f3f4f6; border-radius: 8px; padding: 8px; margin-top: 8px; }
  </style>
</head>
<body>
  <h2>積分：面積の足し合わせを可視化する</h2>
  <p>左端 0 から x = b までの面積を、長方形の足し合わせ（リーマン和）として描画します。分割数を増やすと近似が精密になる様子を観察できます。</p>
  <div class="grid">
    <canvas id="intCanvas" width="720" height="360" aria-label="積分キャンバス"></canvas>
    <div class="panel">
      <h3>操作パネル</h3>
      <label>関数を選択<select id="funcSelect"><option value="square">f(x)=x^2</option><option value="sine">f(x)=sin(x)+1.5</option><option value="exp">f(x)=e^{-x}</option></select></label>
      <label>上限 b
        <input id="upper" type="range" min="0" max="4" step="0.05" value="2" />
      </label>
      <label>分割数 N（長方形の数）
        <input id="nRect" type="range" min="4" max="80" step="2" value="20" />
      </label>
      <div class="stats" id="statsBox"></div>
      <div class="hint" style="margin-top:10px;">
        <strong>見どころ</strong>
        <ul style="padding-left:18px; margin:6px 0;">
          <li>青い帯が長方形近似。分割数を増やすほど面積が滑らかに埋まっていきます。</li>
          <li>緑の線は関数、ピンクの線は「真の」累積面積。差がどのくらいかを数値で確認できます。</li>
          <li>上限 b を動かすと積分値がどのように増えるか（面積の蓄積）をリアルタイムで観察できます。</li>
        </ul>
      </div>
    </div>
  </div>

<script>
const canvas = document.getElementById('intCanvas');
const ctx = canvas.getContext('2d');
const funcSelect = document.getElementById('funcSelect');
const upperSlider = document.getElementById('upper');
const nSlider = document.getElementById('nRect');
const statsBox = document.getElementById('statsBox');

const functions = {
  square: {
    f: (x) => x*x,
    F: (a,b) => (Math.pow(b,3) - Math.pow(a,3))/3,
    label: 'f(x) = x^2'
  },
  sine: {
    f: (x) => Math.sin(x)+1.5,
    F: (a,b) => (-Math.cos(b)+Math.cos(a)) + 1.5*(b-a),
    label: 'f(x) = sin(x) + 1.5'
  },
  exp: {
    f: (x) => Math.exp(-x),
    F: (a,b) => (Math.exp(-a) - Math.exp(-b)),
    label: 'f(x) = e^{-x}'
  }
};

function tx(x) { return x*140 + 40; }
function ty(y) { return canvas.height - (y*90 + 40); }

function drawAxis() {
  ctx.strokeStyle = '#d1d5db';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(30, ty(0));
  ctx.lineTo(canvas.width-20, ty(0));
  ctx.moveTo(40, 10);
  ctx.lineTo(40, canvas.height-30);
  ctx.stroke();
}

function draw() {
  const key = funcSelect.value;
  const {f, F, label} = functions[key];
  const b = parseFloat(upperSlider.value);
  const n = parseInt(nSlider.value, 10);
  const a = 0;
  const dx = (b-a)/n;

  ctx.clearRect(0,0,canvas.width, canvas.height);
  drawAxis();

  // 関数
  ctx.strokeStyle = '#10b981';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i=0;i<=400;i++) {
    const x = a + (i/400)*(4.2-a);
    const y = f(x);
    const px = tx(x);
    const py = ty(y);
    i===0 ? ctx.moveTo(px,py) : ctx.lineTo(px,py);
  }
  ctx.stroke();

  // 長方形近似
  ctx.fillStyle = 'rgba(59,130,246,0.35)';
  let approx = 0;
  for (let i=0;i<n;i++) {
    const xLeft = a + i*dx;
    const height = f(xLeft);
    approx += height*dx;
    const x = tx(xLeft);
    const y = ty(height);
    const width = tx(xLeft+dx) - tx(xLeft);
    ctx.fillRect(x, y, width, ty(0) - y);
  }

  // 真の積分曲線
  ctx.strokeStyle = '#ec4899';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for (let i=0;i<=200;i++) {
    const x = a + (i/200)*(4.2-a);
    const area = F(a, x);
    const px = tx(x);
    const py = ty(area);
    i===0 ? ctx.moveTo(px,py) : ctx.lineTo(px,py);
  }
  ctx.stroke();

  // 注釈
  ctx.fillStyle = '#111827';
  ctx.font = '14px Inter, Noto Sans JP, sans-serif';
  ctx.fillText('x = '+b.toFixed(2), tx(b)+6, ty(0)-8);

  const trueVal = F(a,b);
  statsBox.innerHTML = `
    <div><strong>${label}</strong></div>
    <div>上限 b = ${b.toFixed(2)}</div>
    <div>近似面積（長方形の和）≈ ${approx.toFixed(4)}</div>
    <div>真の面積 F(b) = ${trueVal.toFixed(4)}</div>
    <div>誤差 = ${(approx-trueVal).toFixed(5)}</div>
  `;

  requestAnimationFrame(draw);
}

draw();
</script>
</body>
</html>
